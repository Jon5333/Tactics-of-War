<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tactics of War</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    #startScreen, #gameControls { text-align: center; padding: 20px; }
    #battlefield {
      display: grid;
      grid-template-columns: repeat(20, 60px);
      gap: 2px;
      justify-content: center;
      margin: 10px auto;
      background-color: #222;
      padding: 10px;
      border-radius: 8px;
    }
    .tile {
      width: 60px; height: 60px;
      border: 1px solid #aaa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
    }
    .plain { background: #d8d8d8; }
    .hill { background: #c4b087; }
    .forest { background: #5a8f5a; color: white; }
    .river { background: #5daee6; }
    .bridge { background: #997950; }
    .selected { outline: 2px solid red; }
    .france { border: 2px solid blue; }
    .russia { border: 2px solid darkred; }
    .routed { filter: brightness(75%) hue-rotate(-50deg); }
    .unit-label { font-weight: bold; }
    .hp-bar, .morale-bar { font-size: 10px; }
  </style>
</head>
<body>

<div id="startScreen">
  <h1>Tactics of War</h1>
  <div>
    Faction: <span id="deployFaction">France</span><br/>
    <label>Choose General:
      <select id="generalSelector"></select>
    </label><br/>
    <label>Unit Type:
      <select id="unitType">
        <option value="infantry">Infantry</option>
        <option value="cavalry">Cavalry</option>
        <option value="artillery">Artillery</option>
        <option value="general">General</option>
      </select>
    </label><br/><br/>
    <button id="deployBtn">Deploy / Next</button>
  </div>
</div>

<div id="gameControls" style="display:none;">
  <h3 id="turnDisplay">Current Turn: France</h3>
  <button id="endTurnBtn">End Turn</button>
</div>

<div id="battlefield"></div>

<script>
let grid = [], currentFaction = 'france', selectedUnitType = 'infantry', deploymentPhase = true;
let selectedTile = null;

const combatMods = {
  plain: 1,
  hill: 1.1,
  forest: 0.9,
  river: 0.8,
  bridge: 1
};

const generals = {
  france: [ { name: "Napoleon", bonus: 0.25 }, { name: "Murat", bonus: 0.1 } ],
  russia: [ { name: "Kutuzov", bonus: 0.2 }, { name: "Bagration", bonus: 0.15 } ]
};

let selectedGeneral = { france: null, russia: null };

document.getElementById('unitType').onchange = e => selectedUnitType = e.target.value;
document.getElementById('deployBtn').onclick = deployNext;
document.getElementById('endTurnBtn').onclick = endTurn;

function setupGeneralDropdown() {
  const sel = document.getElementById('generalSelector');
  sel.innerHTML = '';
  generals[currentFaction].forEach((g, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = g.name;
    sel.appendChild(opt);
  });
}

function deployNext() {
  const genIdx = document.getElementById('generalSelector').value;
  selectedGeneral[currentFaction] = generals[currentFaction][genIdx];

  if (currentFaction === 'france') {
    currentFaction = 'russia';
    document.getElementById('deployFaction').textContent = 'Russia';
    setupGeneralDropdown();
  } else {
    deploymentPhase = false;
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('gameControls').style.display = 'block';
    document.getElementById('endTurnBtn').style.display = 'inline-block';
    updateTurnDisplay();
  }
}

function updateTurnDisplay() {
  document.getElementById('turnDisplay').textContent = 'Current Turn: ' + (currentFaction === 'france' ? 'France' : 'Russia');
}

function createBattlefield() {
  const bf = document.getElementById('battlefield');
  bf.innerHTML = '';
  grid = [];

  const rows = 20, cols = 20;
  let map = Array(rows).fill().map(() => Array(cols).fill('plain'));

  for (let i = 0; i < 50; i++) {
    let r = Math.floor(Math.random() * rows), c = Math.floor(Math.random() * cols),
        t = Math.random() < 0.5 ? 'forest' : 'hill';
    map[r][c] = t;
  }

  const mid = Math.floor(cols / 2);
  for (let r = 0; r < rows; r++) {
    map[r][mid] = 'river';
    if (Math.random() > 0.7 && mid + 1 < cols) map[r][mid + 1] = 'river';
  }
  map[2][mid] = 'bridge';
  map[17][mid] = 'bridge';

  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const terrain = map[r][c];
      const div = document.createElement('div');
      div.className = `tile ${terrain}`;
      div.dataset.row = r;
      div.dataset.col = c;
      div.dataset.terrain = terrain;
      div.onclick = () => onTileClick(r, c);
      bf.appendChild(div);
      grid.push({ row: r, col: c, terrain, unit: null, element: div });
    }
  }
}

function onTileClick(r, c) {
  const cell = grid.find(t => t.row == r && t.col == c);

  if (deploymentPhase) {
    // Prevent deploying in enemy territory
    if ((currentFaction === 'france' && r >= 10) || (currentFaction === 'russia' && r < 10)) return;
    if (cell.unit) return; // Skip if unit already there

    // ✅ Create the unit
    let unit = {
      type: selectedUnitType,
      faction: currentFaction,
      hp: selectedUnitType === 'general' ? 150 : 100,
      morale: selectedUnitType === 'general' ? 150 : 100 + (selectedGeneral[currentFaction]?.bonus || 0) * 100,
      hasMoved: false,
      hasAttacked: false,
      routed: false,
      routeTurns: 0
    };

    // ✅ Restrict general to one per faction
    if (selectedUnitType === 'general') {
      const alreadyHasGeneral = grid.some(t => t.unit && t.unit.type === 'general' && t.unit.faction === currentFaction);
      if (alreadyHasGeneral) return;
    }

    // ✅ Deploy unit
    cell.unit = unit;
    renderCell(cell);
    return;
  }

  // ✅ Game turn logic (after deployment)
  if (!selectedTile) {
    if (cell.unit && cell.unit.faction === currentFaction && !cell.unit.hasMoved && !cell.unit.routed) {
      selectedTile = cell;
      cell.element.classList.add('selected');
    }
  } else {
    selectedTile.element.classList.remove('selected');
    attemptAction(selectedTile, cell);
    selectedTile = null;
  }
}

function attemptAction(from, to) {
  const unit = from.unit;
  const dist = Math.abs(from.row - to.row) + Math.abs(from.col - to.col);
  if (dist !== 1 || unit.hasMoved) return;

  if (!to.unit) {
    to.unit = unit;
    from.unit = null;
    unit.hasMoved = true;
    renderCell(from);
    renderCell(to);
  } else if (to.unit.faction !== currentFaction && !unit.hasAttacked) {
    let attack = 30 * combatMods[from.terrain];
    to.unit.hp -= attack;
    to.unit.morale -= 25;
    unit.hasAttacked = true;

    const nearbyGeneral = grid.find(t =>
      t.unit && t.unit.type === 'general' &&
      t.unit.faction === unit.faction &&
      Math.abs(t.row - from.row) + Math.abs(t.col - from.col) <= 2
    );
    if (nearbyGeneral) {
      unit.morale += 5;
    }

    if (to.unit.morale <= 30 && !to.unit.routed) {
      to.unit.routed = true;
      to.element.classList.add('routed');
    }

    if (to.unit.hp <= 0 || to.unit.morale <= 0) {
      if (to.unit.type === 'general') {
        grid.forEach(cell => {
          if (cell.unit && cell.unit.faction === to.unit.faction) {
            cell.unit.morale -= 25;
          }
        });
      }
      to.unit = null;
    }

    renderCell(from);
    renderCell(to);
    checkWinCondition();
  }
}

function renderCell(cell) {
  const el = cell.element;
  el.className = `tile ${cell.terrain}`;
  el.textContent = '';
  if (cell.unit) {
    el.classList.add(cell.unit.faction);
    if (cell.unit.routed) el.classList.add('routed');

    const lbl = document.createElement('div');
    lbl.textContent = cell.unit.type[0].toUpperCase();
    lbl.className = 'unit-label';

    const hp = document.createElement('div');
    hp.textContent = `${Math.round(cell.unit.hp)} HP`;
    hp.className = 'hp-bar';

    const mr = document.createElement('div');
    mr.textContent = `${Math.round(cell.unit.morale)} M`;
    mr.className = 'morale-bar';

    el.append(lbl, hp, mr);
  }
}

function endTurn() {
  grid.forEach(cell => {
    if (cell.unit && cell.unit.faction === currentFaction) {
      cell.unit.hasMoved = false;
      cell.unit.hasAttacked = false;
      if (cell.unit.routed) {
        cell.unit.routeTurns++;
        moveRouted(cell);
        if (cell.unit.routeTurns > 3) {
          cell.unit = null;
        }
      }
    }
    renderCell(cell);
  });

  currentFaction = currentFaction === 'france' ? 'russia' : 'france';
  updateTurnDisplay();
  checkWinCondition();
}

function moveRouted(cell) {
  const dirs = [[1, 0], [-1, 0], [0, 1], [0, -1]];
  for (let [dr, dc] of dirs) {
    const nr = cell.row + dr, nc = cell.col + dc;
    const nxt = grid.find(t => t.row === nr && t.col === nc);
    if (nxt && !nxt.unit) {
      nxt.unit = cell.unit;
      nxt.unit.hasMoved = true;
      nxt.unit.routeTurns = cell.unit.routeTurns;
      nxt.unit.routed = true;
      cell.unit = null;
      renderCell(nxt);
      renderCell(cell);
      break;
    }
  }
}

function checkWinCondition() {
  const franceAlive = grid.some(t => t.unit && t.unit.faction === 'france' && !t.unit.routed);
  const russiaAlive = grid.some(t => t.unit && t.unit.faction === 'russia' && !t.unit.routed);
  if (!franceAlive) { alert('Russia Wins!'); resetGame(); }
  if (!russiaAlive) { alert('France Wins!'); resetGame(); }
}

function resetGame() {
  deploymentPhase = true;
  grid = [];
  currentFaction = 'france';
  document.getElementById('startScreen').style.display = 'block';
  document.getElementById('gameControls').style.display = 'none';
  document.getElementById('deployFaction').textContent = 'France';
  setupGeneralDropdown();
  createBattlefield();
}

setupGeneralDropdown();
createBattlefield();
</script>
